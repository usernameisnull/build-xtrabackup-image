name: Docker Multi-Arch Build and Push (XtraBackup)

on:
  # 允许手动触发
  workflow_dispatch:
    inputs:
      xtrabackup_tag:
        description: 'Percona XtraBackup Git Tag/Branch (e.g., 8.0, 8.0.35-33)'
        required: true
        default: '8.0.35-31'
# 必须有 packages: write 权限才能推送到 GHCR
permissions:
  contents: read
  packages: write

env:
  # 镜像名称，请替换 YOUR_GITHUB_USERNAME_OR_ORG 为您的用户名或组织名
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/xtrabackup
  # 默认的镜像标签
  DEFAULT_TAG: 8.0-centos8

jobs:
  build_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        # 启用 QEMU 模拟器，支持跨平台构建
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        # 启用 Buildx 插件，支持多架构构建
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # GITHUB_TOKEN 是 GitHub 提供的默认密钥，用于操作 GHCR
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Define Image Tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # 定义标签策略:
          # - 如果是 tag push (e.g., v8.0), 使用 tag 作为标签
          # - 否则使用默认标签
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=${{ env.DEFAULT_TAG }}
            type=sha,format=short

      - name: Build and Push Multi-Arch Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile # 指定 Dockerfile 路径
          # 指定要构建的架构
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 使用 GitHub Actions Cache 加速构建
          cache-from: type=gha
          cache-to: type=gha,mode=max